import{a as x,f as A,h as y,p as C,v as D}from"./chunk-SUFPLXEP.js";import{Aa as E,E as k,T as m,X as g,aa as d,ba as T,j as I,l as R,o as u}from"./chunk-XKGJ2RL6.js";var b=(()=>{let o=class o{constructor(e,t){this.document=e,this.platformId=t,this.documentIsAccessible=A(this.platformId)}static getCookieRegExp(e){let t=e.replace(/([\[\]{}()|=;+?,.*^$])/gi,"\\$1");return new RegExp("(?:^"+t+"|;\\s*"+t+")=(.*?)(?:;|$)","g")}static safeDecodeURIComponent(e){try{return decodeURIComponent(e)}catch{return e}}check(e){return this.documentIsAccessible?(e=encodeURIComponent(e),o.getCookieRegExp(e).test(this.document.cookie)):!1}get(e){if(this.documentIsAccessible&&this.check(e)){e=encodeURIComponent(e);let s=o.getCookieRegExp(e).exec(this.document.cookie);return s[1]?o.safeDecodeURIComponent(s[1]):""}else return""}getAll(){if(!this.documentIsAccessible)return{};let e={},t=this.document;return t.cookie&&t.cookie!==""&&t.cookie.split(";").forEach(s=>{let[c,i]=s.split("=");e[o.safeDecodeURIComponent(c.replace(/^ /,""))]=o.safeDecodeURIComponent(i)}),e}set(e,t,s,c,i,a,p,l){if(!this.documentIsAccessible)return;if(typeof s=="number"||s instanceof Date||c||i||a||p){let f={expires:s,path:c,domain:i,secure:a,sameSite:p||"Lax",partitioned:l};this.set(e,t,f);return}let n=encodeURIComponent(e)+"="+encodeURIComponent(t)+";",r=s||{};if(r.expires)if(typeof r.expires=="number"){let f=new Date(new Date().getTime()+r.expires*1e3*60*60*24);n+="expires="+f.toUTCString()+";"}else n+="expires="+r.expires.toUTCString()+";";r.path&&(n+="path="+r.path+";"),r.domain&&(n+="domain="+r.domain+";"),r.secure===!1&&r.sameSite==="None"&&(r.secure=!0,console.warn(`[ngx-cookie-service] Cookie ${e} was forced with secure flag because sameSite=None.More details : https://github.com/stevermeister/ngx-cookie-service/issues/86#issuecomment-597720130`)),r.secure&&(n+="secure;"),r.sameSite||(r.sameSite="Lax"),n+="sameSite="+r.sameSite+";",r.partitioned&&(n+="Partitioned;"),this.document.cookie=n}delete(e,t,s,c,i="Lax"){if(!this.documentIsAccessible)return;let a=new Date("Thu, 01 Jan 1970 00:00:01 GMT");this.set(e,"",{expires:a,path:t,domain:s,secure:c,sameSite:i})}deleteAll(e,t,s,c="Lax"){if(!this.documentIsAccessible)return;let i=this.getAll();for(let a in i)i.hasOwnProperty(a)&&this.delete(a,e,t,s,c)}};o.\u0275fac=function(t){return new(t||o)(d(x),d(E))},o.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"});let h=o;return h})();var w="No active account",v="token_not_valid",N="bad_authorization_header";var B=(()=>{let o=class o extends D{constructor(e){super(e),this.resource="auth",this.accessTokenKey="access_token",this.refreshTokenKey="refresh_token",this.cookieService=T(b),this.router=T(C),this.refreshTokenInProgress=!1,this.tokenRefreshedSource=new I,this.tokenRefreshed$=this.tokenRefreshedSource.asObservable()}register(e){return this.httpClient.post(`${this.getEndpoint()}/register`,e).pipe(k(t=>u(()=>t)))}login(e){return this.httpClient.post(`${this.getEndpoint()}/login`,e,{withCredentials:!0}).pipe(m(t=>this.setTokens(t)),k(t=>u(()=>t)))}logout(){return this.httpClient.post(`${this.getEndpoint()}/logout`,{refresh:this.getRefreshToken()},{withCredentials:!0}).pipe(m({complete:()=>{this.setTokens({access:"",refresh:""})}}))}refreshToken(){return console.log("Attempting token refresh..."),this.httpClient.post(`${this.getEndpoint()}/login/refresh`,{refresh:this.getRefreshToken()},{withCredentials:!0}).pipe(m(e=>this.setTokens(e)),k(e=>(console.error("Error refreshing token:",e),u(()=>e))))}setTokens(e){this.cookieService.set(this.accessTokenKey,e.access),this.cookieService.set(this.refreshTokenKey,e.refresh)}getAccessToken(){return this.cookieService.get(this.accessTokenKey)}getRefreshToken(){return this.cookieService.get(this.refreshTokenKey)}isLoggedIn(){let e=this.getDecodedToken(!0)||this.getDecodedToken(!1);if(!e)return!1;let t=Math.floor(Date.now()/1e3);return e.exp>t}getDecodedToken(e){let t=e?this.getAccessToken():this.getRefreshToken();if(!t)return null;let s=t.split(".");if(s.length!==3)return null;let c=s[1];try{let i=window.atob(c),a=JSON.parse(i),{token_type:p,exp:l,iat:n,jti:r,user_id:f}=a;return typeof p!="string"||typeof l!="number"||typeof n!="number"||typeof r!="string"||typeof f!="number"?null:{token_type:p,exp:l,iat:n,jti:r,user_id:f}}catch(i){return console.error("Error decoding token:",i),null}}handleAuthError(e,t,s){return e.error.detail.includes(w)?u(()=>new Error("Invalid credentials.")):e.error.code===v?R:e.error.code===N?(console.error("Token expired or invalid, attempting token refresh..."),this.router.navigate(["login"]),u(()=>new Error("Invalid token."))):u(()=>new Error("Unhandled auth error."))}};o.\u0275fac=function(t){return new(t||o)(d(y))},o.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"});let h=o;return h})();export{B as a};
